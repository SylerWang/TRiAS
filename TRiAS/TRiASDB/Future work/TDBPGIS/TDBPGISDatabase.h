// $Header: $
// Copyright© 1998-2002 GEOPunkt GmbH & Co. KG, NL Potsdam, All rights reserved
// Created: 25.02.2002 16:45:45
//
// This file was generated by the TRiASDB Data Server Wizard V1.02.117 (#HK010502)
//
// THIS CODE AND INFORMATION IS PROVIDED "AS IS" WITHOUT WARRANTY OF ANY 
// KIND, EITHER EXPRESSED OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE
// IMPLIED WARRANTIES OF MERCHANTABILITY AND/OR FITNESS FOR A PARTICULAR 
// PURPOSE.
//
// @doc 
// @module TDBPGISDatabase.h | Datenbankobjekt TRiASDB Data Server TDBPGIS

#if !defined(_TDBPGISDATABASE_H__932B1CEA_F2E8_4757_A854_8E0257DDA4BA__INCLUDED_)
#define _TDBPGISDATABASE_H__932B1CEA_F2E8_4757_A854_8E0257DDA4BA__INCLUDED_

#if _MSC_VER >= 1000
#pragma once
#endif // _MSC_VER >= 1000

// Header include diagnostics
#if defined(_TRIAS_DBG_HEADER_DIAGNOSTICS)
#pragma message(__TIME__": include " __FILE__ )
#endif

#include "resource.h"       // main symbols

#include <Com/OleItemContainerSupport.h>

#include "TDBPGISPropertyBase.h"
#include "TDBPGISPropertySupport.h"

#include "PolyGISDatasource.h"

/////////////////////////////////////////////////////////////////////////////
// CTDBPGISDatabase
class ATL_NO_VTABLE CTDBPGISDatabase : 
	public CComObjectRootEx<CComObjectThreadModel>,
	public CComCoClass<CTDBPGISDatabase, &CLSID_TDBPGISDatabase>,
	public CErrSupport<CTDBPGISDatabase, &IID_ITRiASDatabase>,
	public CManagePropertyBase<CTDBPGISDatabase>,
	public CManagePropertySupport<CTDBPGISDatabase>,
	public COleItemContainerSupport<CTDBPGISDatabase>,
	public IDispatchImpl<ITRiASAccessDatabase, &IID_ITRiASAccessDatabase, &LIBID_TRiASDB,
		TYPELIB_TRiASDB_VERSION_MAJOR, TYPELIB_TRiASDB_VERSION_MINOR>,
	public IDispatchImpl<ITRiASDatabase, &IID_ITRiASDatabase, &LIBID_TRiASDB,
		TYPELIB_TRiASDB_VERSION_MAJOR, TYPELIB_TRiASDB_VERSION_MINOR>
{
public:
	CTDBPGISDatabase() :
		m_bstrName(g_cbNil), m_fOpened(false), m_fIsDirty(false)
	{
	}

	_ATLX_DEBUG_OBJECTCOUNT_IMPL(CTDBPGISDatabase)

	DECLARE_REGISTRY_RESOURCEID(IDR_TDBPGISDATABASE_RGS)
	DECLARE_PROTECT_FINAL_CONSTRUCT()

	BEGIN_COM_MAP(CTDBPGISDatabase)
		COM_INTERFACE_ENTRY(ITRiASDatabase)
		COM_INTERFACE_ENTRY(ITRiASAccessDatabase)
		COM_INTERFACE_ENTRY(ITRiASBase)
		COM_INTERFACE_ENTRY(ITRiASPropertyBase)			// --> CManagePropertyBase
		COM_INTERFACE_ENTRY(ITRiASPropertySupport)		// --> CManagePropertySupport
		COM_INTERFACE_ENTRY(ISupportErrorInfo)
		COM_INTERFACE_ENTRY(IOleItemContainer)			// --> COleItemContainerSupport
		COM_INTERFACE_ENTRY(IOleContainer)				// --> COleItemContainerSupport
		COM_INTERFACE_ENTRY(IParseDisplayName)			// --> COleItemContainerSupport
		COM_INTERFACE_ENTRY2(IDispatch, ITRiASDatabase)
	END_COM_MAP()

	BEGIN_PROPERTYSUPPORT_MAP(CTDBPGISDatabase)
// BEGIN_SAMPLE_CODE
		PROPERTYSUPPORT_ENTRY(g_cbObjectMap, CLSID_GenObjectMap)		// Zuordnung ObjectCursor --> pIObject
		PROPERTYSUPPORT_ENTRY(g_cbObjectsMap, CLSID_GenObjectMap)		// Zuordnung ObjectsCursor --> pIObjects
		PROPERTYSUPPORT_ENTRY(g_cbFeatureMap, CLSID_GenObjectMap)		// Zuordnung FeatureCursor --> pIFeature
// END_SAMPLE_CODE
		PROPERTYSUPPORT_ENTRY_DEFAULT(CLSID_TRiASAutoSaveProperty)
	END_PROPERTYSUPPORT_MAP()

	BEGIN_OLEITEMCONTAINERSUPPORT_MAP(CTDBPGISDatabase)
		OLEITEMCONTAINERSUPPORT_ENTRYEX(g_cbMkObjectsDef, GetObjectsDef, ParseObjectsDef)
		OLEITEMCONTAINERSUPPORT_ENTRYEX(g_cbMkObjectDef, GetObjectDef, ParseObjectDef)
	END_OLEITEMCONTAINERSUPPORT_MAP()

	HRESULT FinalConstruct();
	void FinalRelease();

	IDispatch *GetDispatch() { return static_cast<ITRiASDatabase *>(this); }

// ISupportsErrorInfo
	STDMETHOD(InterfaceSupportsErrorInfo)(REFIID riid);

public:
// ITRiASDatabase
	STDMETHOD(get_VersionLong)(LONG * pVal);
	STDMETHOD(get_Handle)(INT_PTR * pVal);
	STDMETHOD(get_IsDirty)(VARIANT_BOOL * pVal);
	STDMETHOD(put_IsDirty)(VARIANT_BOOL pVal);
	STDMETHOD(get_OpenedAsCopy)(VARIANT_BOOL * pVal);
	STDMETHOD(get_CouldOpenTarget)(VARIANT_BOOL * pVal);
	STDMETHOD(get_SchemaUpdatable)(VARIANT_BOOL * pVal);
	STDMETHOD(get_Name)(BSTR * pVal);
	STDMETHOD(get_Version)(BSTR * pVal);
	STDMETHOD(get_CollatingOrder)(LONG * pVal);
	STDMETHOD(get_Connect)(BSTR * pVal);
	STDMETHOD(get_Transactions)(VARIANT_BOOL * pVal);
	STDMETHOD(get_Updatable)(VARIANT_BOOL * pVal);
	STDMETHOD(get_Temporary)(VARIANT_BOOL * pVal);
	STDMETHOD(put_Temporary)(VARIANT_BOOL pVal);
	STDMETHOD(get_TemporaryName)(BSTR * pVal);
	STDMETHOD(get_Type)(BSTR * pVal);
	STDMETHOD(get_StorageMode)(DATABASESTORAGEMODE * pVal);
	STDMETHOD(CreateDatabase)(BSTR Name, BSTR Locale, BSTR Source);
	STDMETHOD(CreateDatabaseFromFiles)(IUnknown * FileNames, BSTR Locale, BSTR Source);
	STDMETHOD(CreateDatabaseOnStg)(IUnknown *pIUnk, BSTR Name, BSTR Locale, BSTR Source);
	STDMETHOD(OpenDatabase)(BSTR Name, VARIANT_BOOL Exclusive, VARIANT_BOOL ReadOnly, VARIANT_BOOL ModTrack, BSTR Source);
	STDMETHOD(OpenFilesAsDatabase)(IUnknown * FileNames, VARIANT_BOOL Exclusive, VARIANT_BOOL ReadOnly, VARIANT_BOOL ModTrack, BSTR Source);
	STDMETHOD(OpenStorageAsDatabase)(IUnknown *pIStorage, VARIANT_BOOL Exclusive, VARIANT_BOOL fReadOnly, VARIANT_BOOL ModTrack, BSTR Source);
	STDMETHOD(Save)();
	STDMETHOD(SaveAs)(BSTR NewName);
	STDMETHOD(Close)();
	STDMETHOD(BeginTrans)();
	STDMETHOD(ClearModificationLog)(LONG Entry);
	STDMETHOD(CommitTrans)();
	STDMETHOD(Rollback)();
	STDMETHOD(ReLoad)(RELOADDATABASE ToReLoad);

// ITRiASBase
	STDMETHODIMP get_Application(IDispatch **pVal);
	STDMETHODIMP put_Application(IDispatch *newVal);
	STDMETHODIMP get_Parent(IDispatch **pVal);
	STDMETHODIMP put_Parent(IDispatch *newVal);

// ITRiASAccessDatabase
	STDMETHOD(get_Views)(ITRiASViews **pVal);
	STDMETHOD(get_StartViewName)(BSTR *pVal);
	STDMETHOD(get_ObjectsDefs)(ITRiASObjectsCollection **pVal);
	STDMETHOD(get_ObjectsDef)(VARIANT vItem, VARIANT_BOOL fCreate, BSTR Type, ITRiASObjects * *pVal);
	STDMETHOD(get_Envelope)(ENVELOPETYPE rgType, IDispatch **pVal);
	STDMETHOD(get_ObjectCount)(long *pVal);
	STDMETHOD(get_AttachedCS)(BSTR bstrDbName, BSTR *pbstrAssocCS);

// ITRiASPropertyBase
	STDMETHOD(CreateProperty)(BSTR bstrKey, ITRiASProperty **ppIProp)
		{ return CManagePropertySupport<CTDBPGISDatabase>::CreateProperty (bstrKey, ppIProp); }
	STDMETHOD(RemoveProperty)(BSTR bstrKey)
		{ return CManagePropertySupport<CTDBPGISDatabase>::RemoveProperty (bstrKey); }

protected:
// Koordinatensystem behandeln
	HRESULT InitCoordSystemService(BSTR bstrCS);
	HRESULT ShutdownCoordSystemService();

// ReLoad-Funktionalität
	HRESULT OnReLoadObjects();
	HRESULT OnReLoadEnvelope();

	HRESULT EnsureObjectsDefs (ITRiASObjectsCollection **pVal = NULL);

// Datenbank ist geöffnet
	BOOL IsOpened() { return m_fOpened ? TRUE : FALSE; }

// OleItemContainerSupport (s. BEGIN_OLEITEMCONTAINERSUPPORT_MAP)
	HRESULT GetObjectsDef (LPCTSTR pcItem, DWORD dwSpeedNeeded, REFIID riid, LPVOID *ppvObj, bool fTestRunningOnly);
	HRESULT GetObjectDef (LPCTSTR pcItem, DWORD dwSpeedNeeded, REFIID riid, LPVOID *ppvObj, bool fTestRunningOnly);
	HRESULT ParseObjectsDef (LPCTSTR pcItem, ULONG ulSkipped, ULONG *pulEaten, IMoniker **ppmkOut);
	HRESULT ParseObjectDef (LPCTSTR pcItem, ULONG ulSkipped, ULONG *pulEaten, IMoniker **ppmkOut);

	HRESULT GetPolyGISPathFromSource (BSTR bstrSource, BSTR *pbstrPath);
	HRESULT GetPolyGISCoordSys(BSTR bstrSource, BSTR *pbstrCS);

private:
	__Interface<IDispatch> m_Application;
	__Interface<IDispatch> m_Parent;

	CComBSTR m_bstrName;		// Name dieser Database
	CPolyGISDatasource m_DB;	// die Datenquelle selbst

	bool m_fOpened;
	bool m_fIsDirty;

	CIID m_CtfGuid;				// Guid des Koordinatensystems dieser Datenquelle

	WTRiASObjectsCollection m_ObjectsDefs;	// alle Objektklassen dieser Datenquelle
};

#endif // !defined(_TDBPGISDATABASE_H__932B1CEA_F2E8_4757_A854_8E0257DDA4BA__INCLUDED_)
