// $Header: $
// Copyright© 1998-2002 GEOPunkt GmbH & Co. KG, NL Potsdam, All rights reserved
// Created: 25.02.2002 16:45:45 
//
// This file was generated by the TRiASDB Data Server Wizard V1.02.117 (#HK010502)
//
// THIS CODE AND INFORMATION IS PROVIDED "AS IS" WITHOUT WARRANTY OF ANY 
// KIND, EITHER EXPRESSED OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE
// IMPLIED WARRANTIES OF MERCHANTABILITY AND/OR FITNESS FOR A PARTICULAR 
// PURPOSE.
//
// @doc
// @module TDBPGISGeometryBlob.h | Geometrie eines Objektes GeoMedia-like aufbereiten

#if !defined(_TDBPGISGEOMETRYBLOB_H__8086E7AD_F0FE_4DD8_9512_C90512581AB3__INCLUDED_)
#define _TDBPGISGEOMETRYBLOB_H__8086E7AD_F0FE_4DD8_9512_C90512581AB3__INCLUDED_

#if _MSC_VER >= 1000
#pragma once
#endif // _MSC_VER >= 1000

// Header include diagnostics
#if defined(_TRIAS_DBG_HEADER_DIAGNOSTICS)
#pragma message(__TIME__": include " __FILE__ )
#endif

#include <ospace/std/vector>
#include <ospace/std/algorithm>

namespace geometryblob {

// Geometrie-Basisstruktur
	typedef struct tagPOINTBASE {
		double X;
		double Y;
		double Z;
	} POINTBASE;

	typedef vector<double> double_v;
	typedef vector<double>::iterator double_i;

/////////////////////////////////////////////////////////////////////////////
// Klasse, die aus einem Geometriefeld ein Geometrie-Blob in einem SAFEARRAY macht
	class CBlobService
	{
	public:
	// Zugriffsfunktionen
		typedef HRESULT (CBlobService::* GETBLOBSIZEPROC)(/*[in]*/unsigned long lCnt, /*[in]*/ void *pData, /*[out]*/unsigned long *plSize);
		typedef HRESULT (CBlobService::* MAKEBLOBPROC)(/*[in]*/unsigned long ulCnt, /*[in]*/double_i itx, /*[in]*/double_i ity, /*[in]*/POINTBASE *pNormal, /*[in]*/ void *pData, /*[in,out]*/BYTE *pBlob);
		typedef HRESULT (CBlobService::* MAKEVERTICESPROC)(/*[in]*/BYTE *pBlob, /*[in]*/double_v &rX, /*[in]*/double_v &rY, /*[in]*/ void *pData);

		typedef struct tagMAKEBLOBDATA {
			const CLSID *pClsId;
			GETBLOBSIZEPROC GetBlobSize;
			MAKEBLOBPROC MakeBlob;
			MAKEVERTICESPROC MakeVertices;
		} MAKEBLOBDATA;

		typedef struct tagTEXTBLOBDATA {
			double dRotation;
			long lFlags;
			string strText;
		} TEXTBLOBDATA;

	public:
		CBlobService() {}
		~CBlobService() {}

		MAKEBLOBDATA *GetMakeBlobData() 
		{
			static MAKEBLOBDATA s_cbMakeBlobs[] = {
				{ &CLSID_TRiASCSPointGeometry, GetPointGeometrySize, MakePointGeometryBlob, MakePointVertices },
				{ &CLSID_TRiASCSPolylineGeometry, GetPolylineGeometrySize, MakePolylineGeometryBlob, MakePolylineVertices },
				{ &CLSID_TRiASCSPolygonGeometry, GetPolygonGeometrySize, MakePolygonGeometryBlob, MakePolygonVertices },
				{ &CLSID_TRiASCSTextPointGeometry, GetTextGeometrySize, MakeTextGeometryBlob, MakeTextVertices },
				{ NULL, NULL, NULL, NULL },
			};
			return s_cbMakeBlobs;
		}

	// GETBLOBSIZEPROC
		HRESULT GetPointGeometrySize (unsigned long lCnt, void *pData, unsigned long *plSize);
		HRESULT GetPolylineGeometrySize (unsigned long lCnt, void *pData, unsigned long *plSize);
		HRESULT GetPolygonGeometrySize (unsigned long lCnt, void *pData, unsigned long *plSize);
		HRESULT GetTextGeometrySize (unsigned long lCnt, void *pData, unsigned long *plSize);

	// MAKEBLOBPROC
		HRESULT MakePointGeometryBlob (unsigned long ulCnt, double_i itx, double_i ity, POINTBASE *pNormal, void *pData, BYTE *pBlob);
		HRESULT MakePolylineGeometryBlob (unsigned long ulCnt, double_i itx, double_i ity, POINTBASE *pNormal, void *pData, BYTE *pBlob);
		HRESULT MakePolygonGeometryBlob (unsigned long ulCnt, double_i itx, double_i ity, POINTBASE *pNormal, void *pData, BYTE *pBlob);
		HRESULT MakeTextGeometryBlob (unsigned long ulCnt, double_i itx, double_i ity, POINTBASE *pNormal, void *pData, BYTE *pBlob);

	// MAKEVERTICESPROC
		HRESULT MakePointVertices (BYTE *pBlob, double_v &rX, double_v &rY, void *pData);
		HRESULT MakePolylineVertices (BYTE *pBlob, double_v &rX, double_v &rY, void *pData);
		HRESULT MakePolygonVertices (BYTE *pBlob, double_v &rX, double_v &rY, void *pData);
		HRESULT MakeTextVertices (BYTE *pBlob, double_v &rX, double_v &rY, void *pData);

	public:
		HRESULT GetBlobSize (REFCLSID rClsId, unsigned long lCnt, void *pData, unsigned long *plSize);
		HRESULT MakeBlob (REFCLSID rClsId, unsigned long ulCnt, double_i itx, double_i ity, POINTBASE *pNormal, void *pData, BYTE *pBlob);
		HRESULT MakeVertices (REFCLSID rClsId, BYTE *pBlob, double_v &rX, double_v &rY, void *pData);
	};

/////////////////////////////////////////////////////////////////////////////
// Helperfunktionen
	HRESULT CreateSABlobFromVertices (double_v &rX, double_v &rY, POINTBASE *pNormal, void *pData, REFCLSID rClsId, SAFEARRAY **pSA);
	HRESULT CreateBlobFromVertices (unsigned long ulCnt, double_i itx, double_i ity, POINTBASE *pNormal, void *pData, REFCLSID rClsId, void **pBlob, unsigned long *plSize);
	HRESULT CreateSABlobBoundaryFromArray (unsigned long lCnt, void **ppData, unsigned long *pSizes, SAFEARRAY **pSA);

	HRESULT CreateVerticesFromSABlob (SAFEARRAY *pSA, double_v &rX, double_v &rY, void *pData, REFCLSID rClsId);
	HRESULT CreateVerticesFromBlob (BYTE *pBlob, double_v &rX, double_v &rY, void *pData, REFCLSID rClsId);
	HRESULT CreateArrayFromSABlobBoundary (SAFEARRAY *pSA, vector<BYTE *> &rBlobs, vector<unsigned long> &rSizes);

	BOOL BlobHasBoundaryGeometry (SAFEARRAY *pSA);

} // namespace geometryblob

#endif // !defined(_TDBPGISGEOMETRYBLOB_H__8086E7AD_F0FE_4DD8_9512_C90512581AB3__INCLUDED_)
