// $Header: $
// Copyright© 1998-2000 TRiAS GmbH Potsdam, All rights reserved
// Created: 14.09.2000 21:21:48
//
// This file was generated by the TRiASDB Data Server Wizard V1.02.103 (#HK000729)
//
// @doc 
// @module TRiASMIDatabase.h | Datenbankobjekt TRiASDB Data Server TRiASMI

#if !defined(_TRIASMIDATABASE_H__49353DC9_8680_4420_B214_4CE3C0E101FC__INCLUDED_)
#define _TRIASMIDATABASE_H__49353DC9_8680_4420_B214_4CE3C0E101FC__INCLUDED_

#if _MSC_VER >= 1000
#pragma once
#endif // _MSC_VER >= 1000

// Header include diagnostics
#if defined(_TRIAS_DBG_HEADER_DIAGNOSTICS)
#pragma message(__TIME__": include " __FILE__ )
#endif

#include "resource.h"       // main symbols

#include <Com/OleItemContainerSupport.h>

#include "MiTabDatasource.h"
#include "TRiASMIPropertyBase.h"
#include "TRiASMIPropertySupport.h"

/////////////////////////////////////////////////////////////////////////////
// ProgID des zugehörigen Database-Objektes
extern "C" const OLECHAR __declspec(selectany) g_cbDatabase[] = L"TRiASDB.TRiASMIDatabase.1";

/////////////////////////////////////////////////////////////////////////////
// CTRiASMIDatabase
class ATL_NO_VTABLE CTRiASMIDatabase : 
	public CComObjectRootEx<CComObjectThreadModel>,
	public CComCoClass<CTRiASMIDatabase, &CLSID_TRiASMIDatabase>,
	public CErrSupport<CTRiASMIDatabase, &IID_ITRiASDatabase>,
	public CManagePropertyBase<CTRiASMIDatabase>,
	public CManagePropertySupportWithDefaultValues<CTRiASMIDatabase>,
	public COleItemContainerSupport<CTRiASMIDatabase>,
	public IDispatchImpl<ITRiASAccessDatabase, &IID_ITRiASAccessDatabase, &LIBID_TRiASDB,
		TYPELIB_TRiASDB_VERSION_MAJOR, TYPELIB_TRiASDB_VERSION_MINOR>,
	public IDispatchImpl<ITRiASDatabase, &IID_ITRiASDatabase, &LIBID_TRiASDB,
		TYPELIB_TRiASDB_VERSION_MAJOR, TYPELIB_TRiASDB_VERSION_MINOR>
{
public:
	CTRiASMIDatabase() :
		m_bstrName(g_cbNil), m_fOpened(false), m_fIsDirty(false)
	{
	}

	_ATLX_DEBUG_OBJECTCOUNT_IMPL(CTRiASMIDatabase)

	DECLARE_REGISTRY_RESOURCEID(IDR_TRIASMIDATABASE_RGS)
	DECLARE_PROTECT_FINAL_CONSTRUCT()

	BEGIN_COM_MAP(CTRiASMIDatabase)
		COM_INTERFACE_ENTRY(ITRiASDatabase)
		COM_INTERFACE_ENTRY(ITRiASAccessDatabase)
		COM_INTERFACE_ENTRY(ITRiASBase)
		COM_INTERFACE_ENTRY(ITRiASPropertyBase)			// --> CManagePropertyBase
		COM_INTERFACE_ENTRY(ITRiASPropertySupport)		// --> CManagePropertySupport
		COM_INTERFACE_ENTRY(ISupportErrorInfo)
		COM_INTERFACE_ENTRY(IOleItemContainer)			// --> COleItemContainerSupport
		COM_INTERFACE_ENTRY(IOleContainer)				// --> COleItemContainerSupport
		COM_INTERFACE_ENTRY(IParseDisplayName)			// --> COleItemContainerSupport
		COM_INTERFACE_ENTRY2(IDispatch, ITRiASDatabase)
		COM_INTERFACE_ENTRY_THIS()
	END_COM_MAP()

	BEGIN_PROPERTYSUPPORT_MAP(CTRiASMIDatabase)
		PROPERTYSUPPORT_ENTRY(g_cbObjectsMap, CLSID_GenObjectMap)		// Zuordnung ObjectsCursor --> pIObjects
		PROPERTYSUPPORT_ENTRY(g_cbFeatureMap, CLSID_GenObjectMap)		// Zuordnung FeatureCursor --> pIFeature
		PROPERTYSUPPORT_ENTRY(g_cbMetaDataMap, CLSID_TRiASMetaDataMap)
		PROPERTYSUPPORT_ENTRY_DEFAULTINITFUNC(g_cbGDODataSource, CLSID_TRiASVariantProperty)	// steht für Beschreibbarkeit der Metadaten trotz RO-Dataserver
		PROPERTYSUPPORT_ENTRY_DEFAULT(CLSID_TRiASAutoSaveProperty)
	END_PROPERTYSUPPORT_MAP()

// nicht sehr schön, dafür aber selten ...
// die folgende Funktion sollte irgend wie automatisch generiert werden
	HRESULT RefreshingProperties()
	{
		return ChangeMapEntry(CComBSTR(g_cbGDODataSource), (INT_PTR)&CLSID_TRiASVariantProperty, PROPERTYSUPPORT_HASINITDATA, vtMissing, GetDefaultValuesProc());
	}

// Defaultwerte für Properties
	BEGIN_PROPERTYSUPPORT_DEFAULTVALUE_MAP()
		PROPERTYSUPPORT_DEFAULTVALUE_ENTRY(g_cbGDODataSource, VT_BOOL, VARIANT_TRUE, PROPERTY_TYPE_System|PROPERTY_TYPE_ReadOnly|PROPERTY_TYPE_Hidden)
	END_PROPERTYSUPPORT_DEFAULTVALUE_MAP()

	BEGIN_OLEITEMCONTAINERSUPPORT_MAP(CTRiASMIDatabase)
		OLEITEMCONTAINERSUPPORT_ENTRYEX(g_cbMkObjectsDef, GetObjectsDef, ParseObjectsDef)
		OLEITEMCONTAINERSUPPORT_ENTRYEX(g_cbMkObjectDef, GetObjectDef, ParseObjectDef)
	END_OLEITEMCONTAINERSUPPORT_MAP()

	HRESULT FinalConstruct();
	void FinalRelease();

	IDispatch *GetDispatch() { return static_cast<ITRiASDatabase *>(this); }

// ISupportsErrorInfo
	STDMETHOD(InterfaceSupportsErrorInfo)(REFIID riid);

public:
// ITRiASDatabase
	STDMETHOD(get_VersionLong)(LONG * pVal);
	STDMETHOD(get_Handle)(INT_PTR * pVal);
	STDMETHOD(get_IsDirty)(VARIANT_BOOL * pVal);
	STDMETHOD(put_IsDirty)(VARIANT_BOOL pVal);
	STDMETHOD(get_OpenedAsCopy)(VARIANT_BOOL * pVal);
	STDMETHOD(get_CouldOpenTarget)(VARIANT_BOOL * pVal);
	STDMETHOD(get_SchemaUpdatable)(VARIANT_BOOL * pVal);
	STDMETHOD(get_Name)(BSTR * pVal);
	STDMETHOD(get_Version)(BSTR * pVal);
	STDMETHOD(get_CollatingOrder)(LONG * pVal);
	STDMETHOD(get_Connect)(BSTR * pVal);
	STDMETHOD(get_Transactions)(VARIANT_BOOL * pVal);
	STDMETHOD(get_Updatable)(VARIANT_BOOL * pVal);
	STDMETHOD(get_Temporary)(VARIANT_BOOL * pVal);
	STDMETHOD(put_Temporary)(VARIANT_BOOL pVal);
	STDMETHOD(get_TemporaryName)(BSTR * pVal);
	STDMETHOD(get_Type)(BSTR * pVal);
	STDMETHOD(get_StorageMode)(DATABASESTORAGEMODE * pVal);
	STDMETHOD(CreateDatabase)(BSTR Name, BSTR Locale, BSTR Source);
	STDMETHOD(CreateDatabaseFromFiles)(IUnknown * FileNames, BSTR Locale, BSTR Source);
	STDMETHOD(CreateDatabaseOnStg)(IUnknown *pIUnk, BSTR Name, BSTR Locale, BSTR Source);
	STDMETHOD(OpenDatabase)(BSTR Name, VARIANT_BOOL Exclusive, VARIANT_BOOL ReadOnly, VARIANT_BOOL ModTrack, BSTR Source);
	STDMETHOD(OpenFilesAsDatabase)(IUnknown * FileNames, VARIANT_BOOL Exclusive, VARIANT_BOOL ReadOnly, VARIANT_BOOL ModTrack, BSTR Source);
	STDMETHOD(OpenStorageAsDatabase)(IUnknown *pIStorage, VARIANT_BOOL Exclusive, VARIANT_BOOL fReadOnly, VARIANT_BOOL ModTrack, BSTR Source);
	STDMETHOD(Save)();
	STDMETHOD(SaveAs)(BSTR NewName);
	STDMETHOD(Close)();
	STDMETHOD(BeginTrans)();
	STDMETHOD(ClearModificationLog)(LONG Entry);
	STDMETHOD(CommitTrans)();
	STDMETHOD(Rollback)();
	STDMETHOD(ReLoad)(RELOADDATABASE ToReLoad);
	STDMETHOD(RefreshChangesFromModificationLog)(ITRiASRefreshChangesCallback *pICallback);

// ITRiASBase
	STDMETHODIMP get_Application(IDispatch **pVal);
	STDMETHODIMP put_Application(IDispatch *newVal);
	STDMETHODIMP get_Parent(IDispatch **pVal);
	STDMETHODIMP put_Parent(IDispatch *newVal);

// ITRiASAccessDatabase
	STDMETHOD(get_Views)(ITRiASViews **pVal);
	STDMETHOD(get_StartViewName)(BSTR *pVal);
	STDMETHOD(get_ObjectsDefs)(ITRiASObjectsCollection **pVal);
	STDMETHOD(get_ObjectsDef)(VARIANT vItem, VARIANT_BOOL fCreate, BSTR Type, ITRiASObjects * *pVal);
	STDMETHOD(get_Envelope)(ENVELOPETYPE rgType, IDispatch **pVal);
	STDMETHOD(get_ObjectCount)(long *pVal);
	STDMETHOD(get_AttachedCS)(BSTR bstrDbName, BSTR *pbstrAssocCS);
	STDMETHOD(get_ConnectionFilter)(/*[out, retval]*/ ITRiASConnectionFilter **ppIGeom);
	STDMETHOD(put_ConnectionFilter)(/*[in]*/ ITRiASConnectionFilter *pIGeom);

// ITRiASPropertyBase
	STDMETHOD(CreateProperty)(BSTR bstrKey, ITRiASProperty **ppIProp)
		{ return CManagePropertySupport<CTRiASMIDatabase>::CreateProperty (bstrKey, ppIProp); }
	STDMETHOD(RemoveProperty)(BSTR bstrKey)
		{ return CManagePropertySupport<CTRiASMIDatabase>::RemoveProperty (bstrKey); }

protected:
// Koordinatensystem behandeln
	HRESULT InitCoordSystemService();
	HRESULT ShutdownCoordSystemService();
	HRESULT InitObjectsTable();

// ReLoad-Funktionalität
	HRESULT OnReLoadObjects();
	HRESULT OnReLoadEnvelope();

	HRESULT EnsureObjectsDefs (ITRiASObjectsCollection **pVal = NULL);

// Datenbank ist geöffnet
	BOOL IsOpened() { return m_DB.IsOpened() ? TRUE : FALSE; }

// OleItemContainerSupport (s. BEGIN_OLEITEMCONTAINERSUPPORT_MAP)
	HRESULT GetObjectsDef (LPCTSTR pcItem, DWORD dwSpeedNeeded, REFIID riid, LPVOID *ppvObj, bool fTestRunningOnly);
	HRESULT GetObjectDef (LPCTSTR pcItem, DWORD dwSpeedNeeded, REFIID riid, LPVOID *ppvObj, bool fTestRunningOnly);
	HRESULT ParseObjectsDef (LPCTSTR pcItem, ULONG ulSkipped, ULONG *pulEaten, IMoniker **ppmkOut);
	HRESULT ParseObjectDef (LPCTSTR pcItem, ULONG ulSkipped, ULONG *pulEaten, IMoniker **ppmkOut);

private:
	__Interface<IDispatch> m_Application;
	__Interface<IDispatch> m_Parent;

	CComBSTR m_bstrName;		// Name dieser Database

	bool m_fOpened;
	bool m_fIsDirty;

	WTRiASObjectsCollection m_ObjectsDefs;	// alle Objektklassen dieser Datenquelle
	CMiTabDatasource m_DB;		// die Datenquelle selbst
};

#endif // !defined(_TRIASMIDATABASE_H__49353DC9_8680_4420_B214_4CE3C0E101FC__INCLUDED_)
