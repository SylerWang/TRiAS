// $Header: $
// Copyright© 1998-2000 TRiAS GmbH Potsdam, All rights reserved
// Created: 10.05.2000 19:36:40 
//
// This file was generated by the TRiASDB Data Server Wizard V1.02.086 (#HK000510)
//
// @doc
// @module TRiASHPGeoFeature.h | Declaration of the <c CTRiASHPGeoFeature> class

#if !defined(_TRIASHPGEOFEATURE_H__4885692C_A4D5_4FBD_BC7E_6CF2A98DA14B__INCLUDED_)
#define _TRIASHPGEOFEATURE_H__4885692C_A4D5_4FBD_BC7E_6CF2A98DA14B__INCLUDED_

#if _MSC_VER >= 1000
#pragma once
#endif // _MSC_VER >= 1000

// Header include diagnostics
#if defined(_TRIAS_DBG_HEADER_DIAGNOSTICS)
#pragma message(__TIME__": include " __FILE__ )
#endif

#include "resource.h"       // main symbols

#include "ShapeGeometryTree.h"
#include "ShapeLayer.h"

/////////////////////////////////////////////////////////////////////////////
// SmartIF's
DefineSmartInterface(TRiASFeature);
DefineSmartInterface(TRiASObject);
DefineSmartInterface(TRiASObjects);
DefineSmartInterface(TRiASObjectHandleMap);

/////////////////////////////////////////////////////////////////////////////
// CTRiASHPGeoFeature

class ATL_NO_VTABLE CTRiASHPGeoFeature : 
	public CComObjectRootEx<CComObjectThreadModel>,
	public CComCoClass<CTRiASHPGeoFeature, &CLSID_TRiASHPGeoFeature>,
	public CErrSupport<CTRiASHPGeoFeature, &IID_ITRiASFeature>,
	public IDispatchImpl<ITRiASSearchObjects, &IID_ITRiASSearchObjects, &LIBID_TRiASDB,
		TYPELIB_TRiASDB_VERSION_MAJOR, TYPELIB_TRiASDB_VERSION_MINOR>,
	public ITRiASFeatureCallback
{
public:
	CTRiASHPGeoFeature() :
		m_pTree(NULL)
	{
	}

	_ATLX_DEBUG_OBJECTCOUNT_IMPL(CTRiASHPGeoFeature)

	DECLARE_REGISTRY_RESOURCEID(IDR_TRIASHPGEOFEATURE_RGS)
	DECLARE_AGGREGATE_EX_SUPPORT();

	BEGIN_COM_MAP(CTRiASHPGeoFeature)
		COM_INTERFACE_ENTRY(ITRiASFeatureCallback)
		COM_INTERFACE_ENTRY(ISupportErrorInfo)
		COM_INTERFACE_ENTRY(ITRiASSearchObjects)
		COM_INTERFACE_ENTRY_THIS()

	// durch aggregiertes Objekt implementierte Interfaces
		COM_INTERFACE_ENTRY_AGGREGATE_EX(IID_ITRiASFeature, m_BaseUnk.p)
		COM_INTERFACE_ENTRY_AGGREGATE_EX(IID_ITRiASBase, m_BaseUnk.p)
		COM_INTERFACE_ENTRY_AGGREGATE_EX(IID_IDispatch, m_BaseUnk.p)
		COM_INTERFACE_ENTRY_AGGREGATE_EX(IID_IConnectionPointContainer, m_BaseUnk.p)
		COM_INTERFACE_ENTRY_AGGREGATE_BLIND(m_BaseUnk.p)		// alles andere nicht gesondert behandeln
	END_COM_MAP()

	DECLARE_GET_CONTROLLING_UNKNOWN()
	DECLARE_PROTECT_FINAL_CONSTRUCT()
	HRESULT FinalConstruct()
	{
		RETURN_FAILED_HRESULT(m_BaseUnk.CreateInstance (CLSID_TRiASFeature, CLSCTX_ALL, GetControllingUnknown()));

	WTRiASFeature BaseObj;

		RETURN_FAILED_HRESULT(m_BaseUnk -> QueryInterface(BaseObj.ppi()));
		return BaseObj -> putref_FeatureCallback(this);
	}
	void FinalRelease (void)
	{
		DELETE_OBJ(m_pTree);
		m_BaseUnk.Assign(NULL);
	}

// ISupportsErrorInfo
	STDMETHOD(InterfaceSupportsErrorInfo)(REFIID riid);

// ITRiASFeatureCallback
	STDMETHOD(get_DefaultType)(BSTR *pbstrType);
	STDMETHOD(SetupFeature)(/*[in]*/ SETUPFEATUREMODE rgWhat);
	STDMETHOD(Update)(ITRiASObject *Obj, VARIANT Val);
	STDMETHOD(Eval)(ITRiASObject *Obj, VARIANT *pVal);
	STDMETHOD(EvalEx)(ITRiASObject *Obj, SAFEARRAY **ppConstraints, VARIANT *Val);
	STDMETHOD(OnChanging)(CHANGEDFEATURE rgWhat, VARIANT vNewValue, VARIANT_BOOL *pDisAllow);
	STDMETHOD(OnChanged)(CHANGEDFEATURE rgWhat, VARIANT vOldValue);
	STDMETHOD(Clone)(ITRiASFeature **ppIFeat);
	STDMETHOD(OnFinalRelease)();

// ITRiASSearchObjects
	STDMETHOD(ConsiderSearch)(BSTR Command, SAFEARRAY *pParams);
	STDMETHOD(SearchObjects)(BSTR Command, ITRiASObjects *pIObjs, SAFEARRAY *pParams);
	STDMETHOD(ConstraintObjects)(ITRiASObjects *pObjs);

protected:
#if defined(_READWRITE)
	HRESULT OnChangedName();
	HRESULT OnChangedDescription();
	HRESULT OnChangedHandle();
	HRESULT OnChangedROMode();
	HRESULT OnChangedType();

	HRESULT SetGeometry (ITRiASObject *pIObj, LPCSTR pcName, SAFEARRAY *pGeom);
#endif // defined(_READWRITE)
	HRESULT GetGeometry (ITRiASObject *pIObj, ITRiASFeature *pIFeat, SAFEARRAY **ppsa, const double *pdWindow = NULL, double *pdCont = NULL);

	HRESULT EnsureShapeGeometryTree();

	struct CFindObjectData {
		WTRiASObjects m_Objs;
		WTRiASObjectHandleMap m_Map;
	};
	static HRESULT CALLBACK FindObjectCallBack (SHPObject *pObject, UINT_PTR dwData);

private:
	WUnknown m_BaseUnk;				// aggregiertes Objekt (TRiASFeature)
	CShapeGeometryTree *m_pTree;
};

#endif // !defined(_TRIASHPGEOFEATURE_H__4885692C_A4D5_4FBD_BC7E_6CF2A98DA14B__INCLUDED_)
